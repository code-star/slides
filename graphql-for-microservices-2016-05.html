<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">

<title>GraphQL <br> for Microservices</title>

<meta name="description" content="GraphQL <br> for Microservices">    

  <meta name="author" content="Hamza Haiken" />
  <meta name="author" content="Ishan Sital" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="css/theme/codestar.css" id="theme">

<link href='font/fira-code/fira-code.css' rel='stylesheet' type='text/css'>
<link href='font/conduit-itc-std/conduit-itc-std.css' rel='stylesheet' type='text/css'>
<link href="css/kbdfun.css" rel="stylesheet">

<!-- For syntax highlighting -->
  <link rel="stylesheet" href="css/dracula.css">

<!-- QR Code -->
<script src="js/qrcode.js"></script>

<!-- If the query includes 'print-pdf', use the PDF print sheet -->
<script>
  document.write( '<link rel="stylesheet" href="css/print/' +
    ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + 
    '.css" type="text/css" media="print">' );
</script>

<!--[if lt IE 9]>
<script src="js/html5shiv.js"></script>
<![endif]-->
</head>

<body>

<img id="clouds1" src="img/clouds1.png" />
<img id="clouds2" src="img/clouds2.png" />
<img id="curves" src="img/curves.svg" />

<div class="reveal">

<!-- Any section element inside of this container is displayed as a slide -->
<div class="slides">

<div id="logo-background"></div>
<img id="logo" class="plain logo-still" alt="CODESTAR" src="img/logo-star.svg" />

<section style="height: 100%;">
<h1>GraphQL <br> for Microservices</h1>
<h3>Hamza Haiken</h3><h3>Ishan Sital</h3>
<p>
<h4>19 May 2016</h4>
</p>
<div id="credits">Built by <a href="">Showtime</a></div>
</section>  

<section>
<h1>Follow along</h1>
<h2>Link to the slides</h2>
<center>
  <div id="qrcode"></div>
  <pre id="qrlink"></pre>
</center>
<script type="text/javascript">
var url = window.location.protocol + "//" + window.location.host + window.location.pathname;
var qrcode = new QRCode(document.getElementById("qrcode"), {
    text: url,
    width: 384,
    height: 384,
    border: 2,
    colorDark : "#10579E",
    colorLight : "#ffffff"
});
document.getElementById("qrlink").textContent = url;
</script>
</section>

<section>
  <h1>Contents</h1>
  <nav id="TOC">
    <ul>
    <li><a href="#who-are-we">Who are we?</a></li>
    <li><a href="#wehkamp">Wehkamp <img src="img/graphql/wehkamp.png" style="height:0.7em;margin-bottom:-0.05em" /></a></li>
    <li><a href="#situation">Situation</a></li>
    <li><a href="#goals">Goals</a></li>
    <li><a href="#graphql">GraphQL <img src="img/graphql/graphql.svg" style="height:0.7em;margin-bottom:-0.05em" /></a></li>
    <li><a href="#examples">Examples</a></li>
    <li><a href="#demo-1">Demo 1</a></li>
    <li><a href="#query-service">Query service</a></li>
    <li><a href="#demo-2">Demo 2</a></li>
    <li><a href="#alternatives">Alternatives</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#questions">Questions</a></li>
    </ul>
  </nav>
</section>

<section id="who-are-we" class="level1">
<h1>Who are we?</h1>
<section id="hamza" class="level2">
<h2>Hamza</h2>
<p>Dude from Switzerland who likes to code</p>
<ul>
<li>Started at Codestar in 2015</li>
<li>Currently at Wehkamp, team <span style="background: white; color: #cc22ff; padding:5px; border-radius:3px; padding-bottom: 3px;">Purple</span> (CI/CD)</li>
<li>Blog at <a href="http://tenchi.team2xh.net" class="uri">http://tenchi.team2xh.net</a></li>
</ul>
</section>
<section id="ishan" class="level2">
<h2>Ishan</h2>
<ul>
<li>Started at Codestar in 2015</li>
<li>Currently doing Scala at Wehkamp
<ul>
<li>Team <span style="color: lime; font-size: 1.1em">Lime </span>– Wehkamp Universal App
<ul>
<li>back-end</li>
</ul></li>
</ul></li>
</ul>
<aside class="notes">
<ul>
<li>Hi! My name is Ishaan. I’ve been with Codestar since the end of 2015 en on now on my first full-time Scala assignment at Wehkamp. Currently I’m in Team Lime, which is repsonsible for developing the back-end of the android and iOS mobile apps. In the second half of the presentation i’ll give you a peek into how this works. But for now i’ll give the word back to hamza to talk more about the Wehkamp and it’s infrastructure.</li>
</ul>
</aside>
</section>
</section>
<section id="wehkamp" class="level1">
<h1>Wehkamp <img src="img/graphql/wehkamp.png" style="height:0.7em;margin-bottom:-0.05em" /></h1>
<section id="section" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/wehkamp_site.png" style="width:75.0%" />
</figure>
</section>
<section id="section-1" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/wehkamp_mobile.png" style="height: 70vh;" />
</figure>
</section>
<section id="section-2" class="level2">
<h2></h2>
<ul>
<li>Switch from .NET monolith to Scala microservices (Blaze Architecture)</li>
<li>Combination of products/software/applications that are made or bought</li>
<li>Using the latest technologies</li>
<li>Lots of fun!</li>
</ul>
</section>
<section id="teams" class="level2">
<h2>Teams</h2>
<ul>
<li>Many teams, split in colors</li>
<li>Each team responsible for their services:
<ul>
<li>Maintenance</li>
<li>Deployment</li>
<li>Monitoring</li>
<li>Alerting</li>
</ul></li>
</ul>
</section>
<section id="cicd" class="level2">
<h2>CI/CD</h2>
<ul>
<li>The Blaze Architecture has a strong focus on automation → speed of execution</li>
<li>Platform deployed using <em>Ansible</em></li>
<li>Builds done on Jenkins, with promotion pipelines and integrated testing</li>
<li>All services in containers, deployed on <em>Mesos</em></li>
</ul>
</section>
<section id="microservices" class="level2">
<h2>Microservices</h2>
<ul>
<li>Flexible specification allows for polyglottism:
<ul>
<li>Mainly Scala</li>
<li>Node.js</li>
<li>.NET</li>
</ul></li>
<li>Metadata about services centralized in <em>Consul</em></li>
<li>All services expose a health check endpoint for <em>Marathon</em></li>
<li>All services expose <em>Prometheus</em> metrics, big focus on monitoring</li>
<li>Centralized logging with <em>Elasticsearch</em></li>
</ul>
</section>
<section id="architecture" class="level2">
<h2>Architecture</h2>
<figure>
<img src="img/graphql/blaze-simple.svg" alt="Simple diagram of the Blaze Architecture" style="width:70.0%" /><figcaption>Simple diagram of the Blaze Architecture</figcaption>
</figure>
</section>
<section id="scala-wehkamp" class="level2">
<h2>Scala @ Wehkamp</h2>
<ul>
<li>Main language for services</li>
<li>Aligns with platform goals</li>
</ul>
<p> </p>
<ul>
<li>Most services are actor based using Akka
<ul>
<li>Easy to scale</li>
<li>Akka persistence &amp; clustering</li>
</ul></li>
<li>Routing with Spray</li>
</ul>
</section>
</section>
<section id="situation" class="level1">
<h1>Situation</h1>
<section id="section-3" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/situation_before.svg" alt="Before" style="width:60.0%" /><figcaption>Before</figcaption>
</figure>
</section>
<section id="section-4" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/situation_current.svg" alt="Currently" style="width:40.0%" /><figcaption>Currently</figcaption>
</figure>
</section>
<section id="section-5" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/situation_wanted.svg" alt="What we need" style="width:65.0%" /><figcaption>What we need</figcaption>
</figure>
</section>
</section>
<section id="goals" class="level1">
<h1>Goals</h1>
<section id="section-6" class="level2">
<h2></h2>
<ul>
<li>Reduce number of connections / calls
<ul>
<li>Gives some slack to our Routers and Gateways</li>
<li>Reduces network load on client app</li>
</ul></li>
<li>Reduce amount of data transferred</li>
<li>Avoid upstream long review process when model changes</li>
</ul>
</section>
<section id="section-7" class="level2">
<h2></h2>
<p>Basically, we want to:</p>
<p><em>Merge multiple services into one access point</em></p>
<p>This left us investigating multiple solutions and we chose <strong>GraphQL</strong></p>
</section>
</section>
<section id="graphql" class="level1">
<h1>GraphQL <img src="img/graphql/graphql.svg" style="height:0.7em;margin-bottom:-0.05em" /></h1>
<section id="section-8" class="level2">
<h2></h2>
<p><br><br></p>
<blockquote>
<p>GraphQL is a query language designed to build client applications by providing an intuitive and flexible syntax and system for describing their data requirements and interactions.</p>
</blockquote>
<center>
<em>Facebook (http://facebook.github.io/graphql#sec-Overview)</em>
</center>
</section>
<section id="what-is-it" class="level2">
<h2>What is it?</h2>
<ul>
<li>Abstracts different services into one API</li>
<li>Specification, not a framework</li>
</ul>
</section>
<section id="advantages" class="level2">
<h2>Advantages</h2>
<ul>
<li>Very flexible query language</li>
<li>Has interesting features:
<ul>
<li>Query shaped like the expected data</li>
<li>Introspection</li>
<li>Strongly typed</li>
<li>Recursive queries</li>
</ul></li>
<li>Looks like JSON</li>
<li>Reponses are valid JSON</li>
</ul>
</section>
<section id="facebook" class="level2">
<h2>Facebook <img src="img/graphql/facebook.svg" style="height:0.7em;margin-bottom:-0.05em; border: 2px solid white; border-radius: 3px;" /></h2>
<ul>
<li>Started working on GraphQL in 2012</li>
<li>Needed a “data-fetching API powerful enough <br> to describe <em>all of Facebook</em>” for their mobile app</li>
<li>Has to be easy to learn by product developers</li>
<li>Used today in their apps and servers</li>
<li>Open sourced RFC</li>
</ul>
</section>
<section id="features" class="level2">
<h2>Features</h2>
<p>Pros:</p>
<ul>
<li>Flexibility</li>
<li>Recursive queries</li>
<li>Easy to use</li>
<li>Resilient</li>
</ul>
<p>Cons:</p>
<ul class="minusbullets">
<li>
Need to build a schema by hand
</li>
<li>
Non-trivial resolver implementation
</li>
</ul>
<aside class="notes">
<ul>
<li>Resilient: partial results when down, with error detail</li>
</ul>
</aside>
</section>
<section id="blaze-architecture-goals" class="level2">
<h2>Blaze Architecture goals</h2>
<ul>
<li><strong>Loosely coupled</strong>: prevent unnecessary dependencies</li>
<li><strong>Highly flexible</strong>: enable rapid change</li>
<li><strong>Consistent</strong></li>
<li><strong>Resilient</strong></li>
<li><strong>Elastic</strong>: built-in scalability</li>
<li><strong>Message-driven</strong></li>
<li><strong>Responsive</strong></li>
</ul>
</section>
<section id="section-9" class="level2">
<h2></h2>
<p>We find that GraphQL meets some of these goals quite well:</p>
<ul>
<li><strong>Flexible</strong>: write the scheme once, build powerful queries</li>
<li><strong>Consistent</strong>: the scheme reflects the consistency of the services</li>
<li><strong>Elastic</strong>: no state, can scale by running multiple GraphQL servers</li>
<li><strong>Resilient</strong>: handles errors quite well. <br> Returns partial results when some services are unreachable</li>
</ul>
<p>The only goal not met is the <strong>loose coupling</strong>, but:</p>
<ul>
<li>There’s no current alternative, everyone has to produce a <em>mega</em>-schema</li>
</ul>
</section>
</section>
<section id="examples" class="level1">
<h1>Examples</h1>
<section id="case-1" class="level2">
<h2>Case 1</h2>
<p>Our app needs to retrieve the title of a product.</p>
</section>
<section id="querying-the-product-service" class="level2">
<h2>Querying the product service</h2>
<figure>
<img src="img/graphql/case1_old.svg" alt="Using no query service" style="width:75.0%" /><figcaption>Using no query service</figcaption>
</figure>
</section>
<section id="section-10" class="level2">
<h2></h2>
<pre class="json"><code>{
  &quot;normalized_name&quot;: &quot;apple-ipad-mini-smart-cover-roze-0885909632497&quot;,
  &quot;description&quot;: &quot;&lt;p&gt;...&lt;/p&gt;&quot;,
  &quot;published&quot;: true,
  &quot;product_number&quot;: &quot;748002&quot;,
  &quot;product_type&quot;: &quot;REGULAR&quot;,
  &quot;properties&quot;: [{
    &quot;label&quot;: &quot;Type iPad accessoire&quot;,
    &quot;value&quot;: &quot;Hoes/cover&quot;,
    &quot;code&quot;: &quot;X51&quot;
  }, ...],
  &quot;alternate_urls&quot;: [{
    &quot;culture&quot;: &quot;nl-nl&quot;,
    &quot;url&quot;: &quot;http://www.wehkamp.nl/elektronica/ipad-tablets/ipad-hoesjes/apple-ipad-mini-smart-cover/C26_6F0_F2P_748002/&quot;
  }],
  &quot;package_contents&quot;: &quot;- iPad mini Smart Cover&lt;br /&gt;&quot;,
  &quot;vas_references&quot;: [],
  &quot;title&quot;: &quot;Apple  Ipad mini Smart Cover&quot;,
  &quot;images&quot;: [{
    &quot;file_name&quot;: &quot;748002_eb_01&quot;,
    &quot;category&quot;: &quot;eb&quot;
  }, {
    &quot;file_name&quot;: &quot;748002_pb_01&quot;,
    &quot;category&quot;: &quot;pb&quot;
  }, {
    &quot;file_name&quot;: &quot;748002_eb_02&quot;,
    &quot;category&quot;: &quot;eb&quot;
  }],
  &quot;ean&quot;: &quot;0885909632497&quot;,
  &quot;available_stock&quot;: 3,
  &quot;variants&quot;: [{
    &quot;size&quot;: {
      &quot;code&quot;: &quot;000&quot;,
      &quot;label&quot;: &quot;000&quot;,
      &quot;is_default&quot;: false
    },
    &quot;price&quot;: 3495,
    &quot;scratch_price&quot;: 4195,
    &quot;vat_code&quot;: &quot;VB6&quot;,
    &quot;stock_info&quot;: [{
      &quot;from&quot;: 1,
      &quot;to&quot;: 3,
      &quot;availability&quot;: {
        &quot;min_hours&quot;: 0
      },
      &quot;per_appointment&quot;: false
    }],
    &quot;vat_percentage&quot;: 2100,
    &quot;original_price&quot;: 4195,
    &quot;available_stock&quot;: 3,
    &quot;shipping&quot;: {
      &quot;costs&quot;: 0,
      &quot;vat_code&quot;: &quot;WB6&quot;,
      &quot;vat_percentage&quot;: 2100
    }
  }]
}</code></pre>
<p>Total response length: 1358B (1.326KiB)</p>
</section>
<section id="only-get-what-you-ask-for" class="level2">
<h2>Only get what you ask for</h2>
<figure>
<img src="img/graphql/case1_new.svg" alt="Using a query service" style="width:75.0%" /><figcaption>Using a query service</figcaption>
</figure>
</section>
<section id="section-11" class="level2">
<h2></h2>
<div style="float: left; width: 50%">
<pre class="json"><code>{
 product(748002) {
   title
 }
}</code></pre>
</div>
<div style="float: right; width: 50%">
<pre class="json"><code>{
 &quot;product&quot;: {
   &quot;title&quot;: &quot;Apple  Ipad mini Smart Cover&quot; 
 }
}</code></pre>
</div>
<p>Total response length: 64B (0.0625KiB)</p>
</section>
<section id="case-2" class="level2">
<h2>Case 2</h2>
<p>We need the recommendations for a certain product number,<br> and for each we want the title and image.</p>
<p>For 10 recommendations, we would need to:</p>
<ul>
<li>Query the recommendations service</li>
<li>Parse the response</li>
<li>For each parsed product number:
<ul>
<li>Query the product service</li>
<li>Parse the response</li>
</ul></li>
</ul>
</section>
<section id="section-12" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/case2_old.svg" alt="Using no query service" style="width:30.0%" /><figcaption>Using no query service</figcaption>
</figure>
</section>
<section id="section-13" class="level2">
<h2></h2>
<figure>
<img src="img/graphql/case2_new.svg" alt="Using no query service" style="width:50.0%" /><figcaption>Using no query service</figcaption>
</figure>
</section>
<section id="merging-services" class="level2">
<h2>Merging services</h2>
<div style="float: left; width: 50%">
<pre class="scala"><code>{
  recommendations(product_number: &quot;748002&quot;) {
    products {
      product {
        title
        primary_image {
          file_name
        }
      }
    }
  }
}</code></pre>
</div>
<div style="float: right; width: 50%">
<pre class="json"><code>{
  &quot;data&quot;: {
    &quot;recommendations&quot;: {
      &quot;products&quot;: [
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;Apple iPad mini met Retina Display 16GB Wi-Fi&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;114015_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;Tucano iPad Air 2 Filo folio hoes&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;545728_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;Apple iPad Air met Retina Display 16GB Wi-Fi&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;114718_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;Valenta iPhone 6 plus/ 6s plus flipcover&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;489592_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;C&amp;A Palomino sweater&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;653834_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;C&amp;A Palomino trui&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;660709_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;C&amp;A Palomino jurk&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;691678_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;Melkco iPhone 6/6s Herman leren flipcover&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;646375_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;C&amp;A Palomino sweater&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;674561_pb_01&quot;
            }
          }
        },
        {
          &quot;product&quot;: {
            &quot;title&quot;: &quot;C&amp;A Palomino sweater&quot;,
            &quot;primary_image&quot;: {
              &quot;file_name&quot;: &quot;626283_pb_01&quot;
            }
          }
        }
      ]
    }
  }
}</code></pre>
</div>
</section>
<section id="section-14" class="level2">
<h2></h2>
<table>
<caption>Effective size of useful/needed data: 500B <br> (10 products, titles and image names) <br><br></caption>
<thead>
<tr class="header">
<th style="text-align: left;">Operation</th>
<th style="text-align: right;">Connections</th>
<th style="text-align: right;">Response length</th>
<th style="text-align: right;">Efficiency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Raw</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">~14KiB</td>
<td style="text-align: right;">3.48%</td>
</tr>
<tr class="even">
<td style="text-align: left;">GraphQL</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">~2KiB</td>
<td style="text-align: right;">24.41%</td>
</tr>
</tbody>
</table>
</section>
<section id="case-3" class="level2">
<h2>Case 3</h2>
<p>For a given product, we need:</p>
<ul>
<li>Name</li>
<li>Main picture</li>
<li>10 recommendations, and for each:
<ul>
<li>Name</li>
<li>Main picture</li>
<li>10 recommendations, and for each:
<ul>
<li>Name</li>
<li>Main picture</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="recursion" class="level2">
<h2>Recursion</h2>
<div style="float: left; width: 50%">
<pre class="scala"><code>{
  product(product_number: &quot;748002&quot;) {
    title
    primary_image { file_name }
    recommendations {
      products {
        product {
          title
          primary_image { file_name }
          recommendations {
            products {
              product {
                title
                primary_image { file_name }
              }
            }
          }
        }
      } 
    }
  }
}</code></pre>
</div>
<div style="float: right; width: 50%">
<pre class="json"><code>{
  &quot;data&quot;: {
    &quot;product&quot;: {
      &quot;title&quot;: &quot;Apple  Ipad mini Smart Cover&quot;,
      &quot;primary_image&quot;: {
        &quot;file_name&quot;: &quot;748002_pb_01&quot;
      },
      &quot;recommendations&quot;: {
        &quot;products&quot;: [
          ...
        ]
      }
    }
  }
}</code></pre>
</div>
</section>
<section id="section-15" class="level2">
<h2></h2>
<table>
<caption>Effective size of useful/needed data: ~5KiB <br> (111 products, titles and image names) <br><br></caption>
<thead>
<tr class="header">
<th style="text-align: left;">Operation</th>
<th style="text-align: right;">Connections</th>
<th style="text-align: right;">Response length</th>
<th style="text-align: right;">Efficiency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Raw</td>
<td style="text-align: right;">122</td>
<td style="text-align: right;">~155KiB</td>
<td style="text-align: right;">3.2%</td>
</tr>
<tr class="even">
<td style="text-align: left;">GraphQL</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">~29KiB</td>
<td style="text-align: right;">17.2%</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="demo-1" class="level1">
<h1>Demo 1</h1>
<aside class="notes">
We need to demo: - GrapiQL - Introspection
</aside>
</section>
<section id="query-service" class="level1">
<h1>Query service</h1>
<section id="section-16" class="level2">
<h2></h2>
<p>Given all the goals cited earlier,</p>
<p>we set out to create a Query Service,</p>
<p>aimed at the mobile app (for now)</p>
<aside class="notes">
<ul>
<li>Give short summary of previously defined goals</li>
<li>what are going to talk about now?
<ul>
<li>Architecture</li>
<li>Wiring it together with Scala</li>
<li>Demo</li>
<li>Alternatives</li>
</ul></li>
</ul>
</aside>
</section>
<section id="bff-pattern" class="level2">
<h2>“BFF” Pattern</h2>
<ul>
<li>“Backends For Frontends”</li>
<li>Mobile App logic</li>
<li>Named Queries</li>
</ul>
<aside class="notes">
<ul>
<li>This kind of service is also called BFF: “Backends For Frontends”
<ul>
<li>what is it? A tightly coupled API geared to one specific client application</li>
<li>is also a microservice</li>
</ul></li>
<li>Used by many companies (term coined by Soundcloud)</li>
<li>We do not want logic in apps</li>
<li>Define different APIs for each <em>kind</em> of client</li>
<li>We can do this with GraphQL named queries</li>
</ul>
</aside>
</section>
<section id="examples-1" class="level2">
<h2>Examples</h2>
<p>Mobile BFF:</p>
<pre><code>/mobile/product_title?id=ID
/mobile/recommendation_list?id=ID
...</code></pre>
<p>Desktop BFF:</p>
<pre><code>/desktop/product_informations?id=ID
/desktop/recommendation_tree?id=ID
...</code></pre>
<aside class="notes">
<ul>
<li>How do you call this BFF?</li>
<li>It’s just an namespaced endpoint on our service</li>
</ul>
</aside>
</section>
<section id="microservice-architecture" class="level2">
<h2>Microservice architecture</h2>
<ul>
<li>Scattered data</li>
<li>Network costs</li>
<li>“BFF” fit</li>
<li>Dual functionality:
<ul>
<li>Named Query BFF</li>
<li>Internal GraphQL endpoint</li>
</ul></li>
</ul>
<aside class="notes">
<ul>
<li>Data scattered across multiple services</li>
<li>Internal hops have no cost</li>
<li>“BFF” fits perfectly as an internal microservice</li>
<li>Dual functionality:
<ul>
<li>Named query BFF for mobile clients</li>
<li>Internal GraphQL endpoint for internal services</li>
</ul></li>
</ul>
</aside>
</section>
<section id="section-17" class="level2">
<h2></h2>
<p>Raw GraphQL</p>
<pre class="http"><code>POST query-service.blaze/graphql HTTP/1.1
{
 product(748002) {
   title
 }
}</code></pre>
<p>Named query BFF</p>
<pre class="http"><code>GET query-service.blaze/mobile/get_title?id=748002 HTTP/1.1</code></pre>
<aside class="notes">
<ul>
<li>Both API calls give the same result</li>
<li><ol type="1">
<li>posts the query to be executed</li>
</ol></li>
<li><ol start="2" type="1">
<li>gets defined the endpoint for the title</li>
</ol>
<ul>
<li>under water the graphql is executed to yield the same result</li>
</ul></li>
</ul>
</aside>
</section>
<section id="query-service-architecture" class="level2">
<h2>Query service architecture</h2>
<ul>
<li>Two main routes using Spray
<ul>
<li>Named Queries BFF endpoint</li>
<li>Raw GraphQL endpoint</li>
</ul></li>
<li>Schema</li>
<li>Resolvers</li>
<li>Helpers</li>
</ul>
<aside class="notes">
<ul>
<li>Two main routes using Spray
<ul>
<li>Raw GraphQL endpoint</li>
<li>Named queries</li>
</ul></li>
<li>Manual schema and resolver implementation</li>
<li>Useful helpers reduce the length and redundancy of the code</li>
<li>(Code will be shown later)</li>
</ul>
</aside>
</section>
<section id="sangria" class="level2">
<h2>Sangria <img src="img/graphql/sangria.svg" style="height:0.7em;margin-bottom:-0.05em" /></h2>
<ul>
<li>Young library</li>
<li>Scala alternatives?</li>
<li>Up-to-date</li>
</ul>
<aside class="notes">
<ul>
<li>When we started the POC, it was a bit cumbersome (needed lots of helper functions)</li>
<li>Library is young, updates all the time</li>
<li>Already way easier to use after a few updates</li>
<li>No alternatives for Scala yet</li>
<li>GraphQL spec is still in movement, but Sangria follows closely</li>
</ul>
</aside>
</section>
<section id="schema-definition" class="level2">
<h2>Schema definition</h2>
<ul>
<li>Map JSON responses from external services</li>
<li>case classes</li>
<li>Nesting</li>
<li>Reference to other objects</li>
</ul>
<pre class="scala"><code>case class Recommendation(score: Option[BigDecimal], product_number: Option[String]) {
  @GraphQLField
  def product(implicit ctx: Ctx): Remote[Product] = remote(product_number)
}</code></pre>
<aside class="notes">
<ul>
<li>Reflects the JSON schema of REST API responses from external services</li>
<li>Schema objects defined with Scala case classes</li>
<li>Straight forward thanks to helpers and macros</li>
<li>We add fields when objects need to be nested</li>
<li>Object fields can refer to other objects of the schema</li>
</ul>
Code snippet Voice-Over - Define an object to hold the responses we get from the Recommendation service - case class just like a Java class, 2 parameters score and product_number, with type of Option[BigDecimal] and a Option[String] - Annotation from Sangria to mark the accessor members of the case class, in this case Recommendation has a field “product” - implicit is not important for this example, a context is provided - This function returns a Remote[Product] - It’s implementation is simply calling the remote function with the product_number parameter.
</aside>
</section>
<section id="resolver-definition" class="level2">
<h2>Resolver definition</h2>
<p>First, we need to:</p>
<ul>
<li>Define which service needs to be called</li>
<li>What is the REST endpoint (with placeholder variables)</li>
<li>A magical helper function creates the resolver that:
<ul>
<li>Fetches the JSON</li>
<li>Parses and returns a <code>JsObject</code></li>
</ul></li>
</ul>
<pre class="scala"><code>implicit val RecommendationsResolver: TypedEntityResolver[Recommendations, String] =
  getSingleEntityResolverId(&quot;recommendations-gateway&quot;, &quot;/$id?panel=pdp_rec&quot;)</code></pre>
</section>
<section id="section-18" class="level2">
<h2></h2>
<p>Then, Sangria needs to know how to convert <br> from <code>JsObject</code> to our case class <code>Recommendation</code></p>
<pre class="scala"><code>private implicit val RecommendationFormat = jsonFormat2(Recommendation)</code></pre>
<p>Those two lines are the only things we need to write <br> when we need to add a new service.</p>
</section>
<section id="section-19" class="level2">
<h2></h2>
<ul>
<li>Sangria needs a <code>TypedEntityResolver</code> class that knows where to get data</li>
<li>The <code>resolveSingle()</code> method queries the correct service and returns a <code>JsObject</code></li>
</ul>
<pre class="scala"><code>case class GetSingleEntityResolver(serviceKey: String, path: String)
    extends TypedEntityResolver[JsObject, GetQuery] {

  def resolveSingle(args: GetQuery)
      (implicit ctx: GraphQlContext): Future[Option[JsObject]] = {
    val request = HttpRequest(
      HttpMethods.GET,
      replaceUriPlaceholders(Uri(ctx.services(serviceKey) + path), replace), 
      ...
    )
    ctx.sendReceive(request).map(parseJsonObject)
  }

  override def resolve(...) = items map { item ⇒ resolveSingle(item.args) }
}</code></pre>
</section>
<section id="section-20" class="level2">
<h2></h2>
<ul>
<li><em>Hard coupling</em> between the query service and other services</li>
<li>Also need to actively <em>maintain</em> a schema</li>
</ul>
<p>Is it worth it? <strong>Yes</strong>:</p>
<ul>
<li>Merging services is done in a transparent way</li>
<li>Coupling is not added, but moved</li>
<li>The APIs don’t change that much</li>
<li>Schema easy to write and maintain</li>
<li>Integration testing alerts from API changes</li>
</ul>
</section>
<section id="named-queries" class="level2">
<h2>Named queries</h2>
<p>To avoid putting logic in apps, we can use named queries:</p>
<pre class="php"><code>query($product_numbers: [String!]!) {
  products(product_numbers: $product_numbers) {
    title
    properties {
      label
    }
  }
}</code></pre>
<ul>
<li>Looks like a normal query, wrapped in a <code>query</code> object with parameters</li>
<li>Stored in namespaces (one for each client BFF, for example <code>mobile</code>)</li>
</ul>
</section>
<section id="section-21" class="level2">
<h2></h2>
<p>In our service, we store named queries in files, which has some advantages:</p>
<ul>
<li>They are validated at test time</li>
<li>Easy to maintain a folder hierarchy</li>
<li>Better for version control</li>
<li>All named queries can be compiled at boot time to save resources</li>
</ul>
</section>
<section id="security" class="level2">
<h2>Security</h2>
<ul>
<li>GraphQL only used internally, no outside access</li>
<li>Public facing endpoint are named queries, which remove a lot of external control</li>
<li>Public access still goes through the rest of the platform for other security checks</li>
</ul>
</section>
</section>
<section id="demo-2" class="level1">
<h1>Demo 2</h1>
<aside class="notes">
<ul>
<li>Query service
<ul>
<li>Add named query (take query from Demo 1)</li>
<li>Named query example</li>
</ul></li>
<li>Bit of code
<ul>
<li>Schema</li>
<li>Resolvers</li>
</ul></li>
</ul>
</aside>
</section>
<section id="alternatives" class="level1">
<h1>Alternatives</h1>
<section id="section-22" class="level2">
<h2></h2>
<p>Before jumping in with GraphQL, we also investigated:</p>
<p><img src="img/graphql/finagle.png" style="height:4.95em;margin-bottom:-0.05em; border-radius: 5px;" /> <img src="img/graphql/falcor.svg" style="background: black; padding: 10px; border-radius: 5px; height:4.5em;margin-bottom:-0.05em" /></p>
<p>Both had more cons than pros compared to GraphQL</p>
</section>
<section id="graphql-vs-finagle" class="level2">
<h2>GraphQL vs Finagle</h2>
<ul>
<li>Merging services:
<ul>
<li>In GraphQL, you first set up the resolvers and Schema, <br>then you can combine multiple services at a whim with the powerful <em>query syntax</em></li>
<li>In Finagle, you need to <em>explicitly</em> write “Proxies” <br> for <em>each combination</em> of services that you want to merge</li>
</ul></li>
</ul>
</section>
<section id="graphql-vs-falcor" class="level2">
<h2>GraphQL vs Falcor</h2>
<ul>
<li>GraphQL is a <em>specification</em>, with multiple implementations</li>
<li>Falcor is a <em>JavaScript</em> server <em>application</em></li>
</ul>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<section id="results" class="level2">
<h2>Results</h2>
<ul>
<li>Less data used: between 10% and 20% of original response sizes</li>
<li>Less connections: only one connection for everything</li>
<li>Tailored responses: only get what was asked for</li>
</ul>
</section>
<section id="aftermath" class="level2">
<h2>Aftermath</h2>
<ul>
<li>The mobile team is happy</li>
<li>Current development app uses the new named queries</li>
<li>Investment in the schema enables us to re-use it</li>
</ul>
<aside class="notes">
<ul>
<li>named queries can be added easily.</li>
<li>Front-end centered, you ask from the service what you need
<ul>
<li>When data could not be queried, we need to add it to the schema once</li>
<li>after that we can reuse it</li>
</ul></li>
</ul>
</aside>
</section>
<section id="future" class="level2">
<h2>Future</h2>
<ul>
<li>Automatic schema generation through documentation</li>
<li>Add more BFFs </li>
</ul>
<aside class="notes">
<ul>
<li>use service descriptors to automatically create schema’s, less work
<ul>
<li>no know solutions yet</li>
</ul></li>
<li>connect website, TV apps, VR ? all get there on BFF</li>
</ul>
</aside>
</section>
</section>
<section id="questions" class="level1">
<h1>Questions</h1>
<section id="section-23" class="level2">
<h2></h2>
<p class="huge">
?
</p>
</section>
<section id="section-24" class="level2">
<h2></h2>
<br><br><br>
<p class="big">
Thank you
</p>
</section>
</section>
</div>
</div>

<script src="js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
  function animateLogo() {
    var background = document.getElementById("logo-background");
    var logo = document.getElementById("logo");

    logo.src = "img/logo-animated.svg";
    logo.className = "plain logo-corner";
    background.className += " background-fade-out";

    if (document.getElementById("pressSpace"))
      document.getElementById("pressSpace").parentElement.removeChild(document.getElementById("pressSpace"));

    setTimeout(function() {
      background.parentElement.removeChild(background);
    }, 5500);
  }

  function initReveal() {
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      width: 1280,
      height: 720,
      margin: 0.15,
      controls: true,
      progress: true,
      history: true,
      center: false,
      keyboard: false,

    // available themes are in /css/theme
          theme: Reveal.getQueryHash().theme || 'codestar', 
    
    // default/cube/page/concave/zoom/linear/fade/none
          transition: Reveal.getQueryHash().transition || 'linear',
    
    math: {
      mathjax: 'js/mathjax/MathJax.js',
      config: 'TeX-MML-AM_SVG'  // See http://docs.mathjax.org/en/latest/config-files.html
    },

    // Optional libraries used to extend on reveal.js
    dependencies: [
      { src: 'js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'plugin/math/math.js', async: true },
      { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
      // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
    ]
    });
  }

  function inIframe () {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  }

  // http://stackoverflow.com/a/11381730
  function mobileAndTabletcheck () {
    var check = false;
    (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
    return check;
  }

  var started = false;
  initReveal();

  // Maybe also if hash present?
  if (inIframe() || mobileAndTabletcheck()) {
    var background = document.getElementById("logo-background");
    var logo = document.getElementById("logo");
    background.parentElement.removeChild(background);
    logo.parentElement.removeChild(logo);
  } else {
    var logo = document.getElementById("logo")
    if(logo !== null) {
      logo.style.display = "block";
      var div = document.createElement("div");
      div.id = "pressSpace";
      div.innerHTML = "Press SPACE"
      var parent = document.getElementById("logo").parentElement;
      parent.insertBefore(div, document.getElementById("logo"));
      document.addEventListener('keypress', function (e) {
        if (e.keyCode === 0 || e.keyCode === 32) {
          e.preventDefault();
          if (!started) {
            Reveal.configure({ keyboard: true });
            animateLogo();
            started = true;
          }
        }
      }, false);
    } else {
      Reveal.configure({ keyboard: true });
    }
  }

</script>

</body>
</html>